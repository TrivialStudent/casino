{% extends "base.html" %}
{% block body %}

{% include "navbar.html" %}

<div class="content">
  <div class="box">
    <div class="row"><strong>User:</strong> {{ user.name }}</div>
    <div class="row">
      <strong>Balance:</strong>
      <span id="page-balance">${{ user.balance }}</span>
    </div>
  </div>

  <div class="box">
    {% if not round_active %}
      <form method="post" action="{{ url_for('bet') }}" class="game-form">
        <label><strong>Place bet</strong></label>
        <input type="number" name="amount" min="1" required />
        <button type="submit" class="btn-green">Deal</button>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('hit') }}">
        <button type="submit" class="btn-green">Hit</button>
      </form>
      <form method="post" action="{{ url_for('stand') }}">
        <button type="submit" class="btn-green">Stand</button>
      </form>
    {% endif %}
  </div>

  <div class="box">
    <h3 class="dealer-player">Dealer</h3>
    <div class="game-cards">
      {% for card in dealer_cards %}
        {% if loop.first and round_active %}
          <div class="game-card">?</div>
        {% else %}
          <div class="game-card">
            {{ card.rank_short }}{{ card.suit_symbol }}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <h3 class="dealer-player">You</h3>
    <div class="game-cards">
      {% for card in player_cards %}
        <div class="game-card">
          {{ card.rank_short }}{{ card.suit_symbol }}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function () {
  const el = document.getElementById("page-balance");
  if (!el) return;

  async function update() {
    try {
      const r = await fetch("{{ url_for('_user_snapshot') }}", { cache: "no-store" });
      if (!r.ok) return;
      const d = await r.json();
      if (d && d.auth && typeof d.balance !== "undefined") {
        el.textContent = d.balance;
      }
    } catch (_) {}
  }

  // initial + periodic refresh
  update();
  setInterval(update, 2000);

  // refresh on BFCache restore or when user returns to this page
  window.addEventListener("pageshow", (evt) => {
    const nav = performance.getEntriesByType("navigation")[0];
    if (evt.persisted || (nav && nav.type === "back_forward")) update();
  });
})();
</script>

{% endblock %}
