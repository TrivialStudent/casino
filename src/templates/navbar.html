<header>
  <a href="{{ url_for('home') }}"><h2>All In Santos</h2></a>
  <nav>
    <div class="dropdown">
      <span>Profile<i class="fa-solid fa-caret-down"></i></span>
      <div class="dropdown-content">
        <p>{{ user.pref_name }}</p>
        <p id="nav-balance">Balance: ${{ user.balance }}</p>
        <a href="{{ url_for('deposit') }}" class="menu-link">Deposit</a>
        <a href="{{ url_for('stats') }}" class="menu-link">Statistics</a>
        <a href="{{ url_for('logout') }}" class="logout-red">Log out</a>
      </div>
    </div>
  </nav>
</header>

<script>
(function () {
  const el = document.getElementById("nav-balance");
  if (!el) return;

  const url = "{{ url_for('_user_snapshot') }}";

  async function updateBalance() {
    try {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) return;
      const d = await r.json();
      if (d && d.auth && typeof d.balance !== "undefined") {
        el.textContent = `Balance: $${d.balance}`;
      }
    } catch (_) {}
  }

  // Initial + periodic refresh
  updateBalance();
  setInterval(updateBalance, 2000);

  // Refresh when the dropdown is opened/hovered
  const dd = document.querySelector(".dropdown");
  if (dd) {
    dd.addEventListener("mouseenter", updateBalance);
    dd.addEventListener("click", updateBalance);
  }

  // If page is restored from back/forward cache, re-sync immediately
  window.addEventListener("pageshow", (evt) => {
    const nav = performance.getEntriesByType("navigation")[0];
    if (evt.persisted || (nav && nav.type === "back_forward")) updateBalance();
  });
})();
</script>
